# Детальный план реализации проекта "docling"

## Общая стратегия

Мы выполним поэтапный рефакторинг и реализацию новой архитектуры, описанной в `architecture.md`. Вместо того чтобы переписывать все сразу, мы будем создавать новые модули и постепенно заменять ими старую логику. Каждый шаг будет покрыт тестами в соответствии с принципами TDD, изложенными в `AGENTS.md`.

## Текущий прогресс

- [x] Этап 0: Подготовка и настройка проекта
- [x] Этап 1: Модель документа (Internal AST)
- [x] Этап 2: Адаптер Docling
- [x] Этап 3: Рендеринг в Markdown
- [x] Этап 4: Трансформации и разбиение на главы
- [ ] Этап 5: Сборка и CLI (в процессе; реализованы `core/output/file_naming.py`, `core/output/toc_builder.py`)
- [ ] Этап 6: Завершение и миграция

---

### **Этап 0: Подготовка и настройка проекта (Foundation)**

**Цель:** Создать структуру каталогов и настроить окружение для разработки по TDD.

1.  **Создание структуры каталогов:**
    *   Создать директорию `core` и все вложенные поддиректории: `core/adapters`, `core/model`, `core/transforms`, `core/split`, `core/render`, `core/output`.
    *   Создать директории `tests`, `samples`.

2.  **Настройка зависимостей:**
    *   Создать файл `requirements.txt` (или `pyproject.toml`), включив в него:
        *   `typer`
        *   `pydantic` (для моделей AST)
        *   `pyyaml` (для `config.yaml`)
        *   `pytest`
        *   `lxml`, `beautifulsoup4`
        *   `python-slugify`

3.  **Настройка тестовой среды:**
    *   Настроить `pytest` (через `pytest.ini` или `pyproject.toml`).
    *   Написать первый простой тест для проверки работоспособности тестовой системы.

---

### **Этап 1: Ядро системы — Модель документа (Internal AST)**

**Цель:** Определить внутреннее представление документа (`InternalDoc`), с которым будут работать все модули.

1.  **Реализация `core/model`:**
    *   В `core/model/internal_doc.py` определить базовые классы для AST с использованием `pydantic` (`Block`, `Heading`, `Paragraph`, `Image`, `List`, `Table`, `Inline` и т.д.).
    *   В `core/model/resource_ref.py` определить класс для ссылок на бинарные ресурсы.
    *   В `core/model/metadata.py` определить класс для метаданных документа.

2.  **Тестирование моделей:**
    *   Написать тесты для каждой модели в `tests/test_model.py`, проверяя корректность создания, типизацию и валидацию полей.

---

### **Этап 2: Входной конвейер — Адаптер Docling**

**Цель:** Реализовать чтение исходных файлов и их преобразование в `InternalDoc` AST.

1.  **Реализация `core/adapters/docling_adapter.py`:**
    *   Создать функцию `parse_with_docling(file_path: str) -> (InternalDoc, list[Resource])`.
    *   Реализовать логику маппинга вывода `docling` в наши модели `InternalDoc`.
    *   Реализовать извлечение бинарных ресурсов.

2.  **Тестирование адаптера:**
    *   В `tests/test_adapter.py` использовать "моки" или зафиксированный вывод `docling` для тестового файла из `samples`.
    *   Проверить корректность преобразования в `InternalDoc`.

---

### **Этап 3: Выходной конвейер — Рендеринг в Markdown**

**Цель:** Преобразовать `InternalDoc` AST обратно в Markdown и сохранить ресурсы.

1.  **Реализация `core/render/markdown_renderer.py`:**
    *   Создать функцию `render(doc: InternalDoc, asset_map: dict) -> str`.
    *   Реализовать обход дерева `InternalDoc` (например, через паттерн Visitor) для генерации Markdown.

2.  **Реализация `core/render/assets_exporter.py`:**
    *   Создать функцию `export(resources: list[Resource], output_dir: str) -> dict`.
    *   Реализовать сохранение бинарных данных и дедупликацию по SHA256.
    *   Возвращать `asset_map` вида `{resource_id: "relative/path/to/asset.png"}`.

3.  **Тестирование:**
    *   В `tests/test_render.py` создать вручную объект `InternalDoc` и проверить корректность сгенерированного Markdown и экспортированных ассетов.

---

### **Этап 4: Основная логика — Трансформации и разделение на главы**

**Цель:** Реализовать бизнес-логику обработки и структурирования документа.

1.  **Реализация `core/split/chapter_splitter.py`:**
    *   Создать функцию `split(doc: InternalDoc, rules: ChapterRules) -> list[InternalDoc]`.
    *   Адаптировать логику из старого `splitter.py` для работы с AST.

2.  **Реализация `core/transforms`:**
    *   `normalize.py`: Реализовать базовые очистки AST.
    *   `structure_fixes.py`: Реализовать восстановление нумерации заголовков, адаптировав логику из `heading_numbering.py`.

3.  **Тестирование:**
    *   Написать тесты для сплиттера и каждой трансформации, проверяя корректность модификации AST.

---

### **Этап 5: Сборка и CLI**

**Цель:** Связать все части вместе и предоставить пользовательский интерфейс.

1.  **Реализация `core/output`:**
    *   `file_naming.py`: Генерация имен файлов.
    *   `toc_builder.py`: Создание `index.md` и `manifest.json`.
    *   `writer.py`: Запись файлов на диск.

2.  **Реализация `pipeline.py`:**
    *   Создать оркестрирующий модуль, вызывающий все компоненты в правильном порядке.

3.  **Новый CLI (`doc2chapmd.py`):**
    *   Создать новый CLI-файл с помощью `Typer`, реализовав опции из `architecture.md`.

4.  **Интеграционное тестирование:**
    *   В `tests/test_cli.py` запустить CLI с файлом из `samples` и проверить всю структуру вывода.

---

### **Этап 6: Завершение и миграция**

**Цель:** Интегрировать оставшуюся логику, добавить конфигурацию и "золотые" тесты.

1.  **Миграция `validators.py`:**
    *   Адаптировать валидаторы для работы с `InternalDoc` AST.

2.  **Конфигурация (`config.yaml`):**
    *   Реализовать загрузку конфигурации и ее использование в `pipeline.py`.

3.  **Golden-тесты:**
    *   Создать "золотые" эталоны вывода для документов в `samples` и тесты для сравнения с ними.

4.  **Документация и очистка:**
    *   Обновить `README.md`.
    *   Удалить старые, неиспользуемые файлы (`preprocess.py`, `cli.py`, `mammoth_style_map.map` и т.д.).
